<!DOCTYPE html>
<html lang="en">
<head>
<title>Bootstrap Example</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
<script src="/static/js/highcharts_fun.js"></script>
</head>
<body>
<div class="container-fluid">
<div id="container"></div>

<script>
const colors = Highcharts.getOptions().colors,
browserData = [],
versionsData = [];


let brightness;

json = [{'CLASS2':'a','CLASS3':'a1','EXPENSE':40}
,{'CLASS2':'a','CLASS3':'a2','EXPENSE':10}
,{'CLASS2':'a','CLASS3':'a3','EXPENSE':20}
,{'CLASS2':'b','CLASS3':'b1','EXPENSE':15}
,{'CLASS2':'b','CLASS3':'b2','EXPENSE':300}
,{'CLASS2':'c','CLASS3':'b2','EXPENSE':30}
,{'CLASS2':'c','CLASS3':'b2','EXPENSE':30}
,{'CLASS2':'c','CLASS3':'b2','EXPENSE':30}
,{'CLASS2':'c','CLASS3':'b2','EXPENSE':30}
];
// Build the data arrays

arr = distinct(json,'CLASS2');
total = 0;
for (i = 0; i < arr.length; i++) {
	new_json = jQuery.grep(json, function(e) {return e['CLASS2']==arr[i];});
	y = 0;
	for(j in new_json){
		y += new_json[j]['EXPENSE'];
		versionsData.push({
			name:new_json[j]['CLASS3'],
			y: new_json[j]['EXPENSE'],
			color: Highcharts.color(colors[i]).brighten(brightness).get()
		});
	}
    // add browser data
    browserData.push({
        name: arr[i],
        y: y,
        color: colors[i]
    });
	total += y;
}

//browserData = [{name:'a',y:10,color:colors[1]},{name:'b',y:20,color:colors[2]}];
//versionsData = [{'a1',y:4},{'a2',y:6},{'b1',y:12},{'b2',y:8}];

// Create the chart
Highcharts.chart('container', {
    chart: {
        type: 'pie'
    },
    title: {
        text: 'Browser market share, January, 2022'
    },
    plotOptions: {
        pie: {
            shadow: false,
            center: ['50%', '50%']
        }
    },
    series: [{
        name: 'Browsers',
        data: browserData,
        size: '45%',
        dataLabels: {
            color: '#ffffff',
            distance: '-50%'
        }
    }, {
        name: 'Versions',
        data: versionsData,
        size: '80%',
        innerSize: '60%',
        dataLabels: {
            //format: '<b>{point.name}:</b> <span style="opacity: 0.5">' +
            //    '{y}</span>' + '{point.y}',
			formatter: function() {return Math.round(this.y) + ' (' + Math.round(this.y/total*100) + '%)'},
            filter: {
                property: 'y',
                operator: '>',
                value: 1
            },
            style: {
                fontWeight: 'normal'
            }
        },
        id: 'versions'
    }],
    responsive: {
        rules: [{
            condition: {
                maxWidth: 400
            },
            chartOptions: {
                series: [{
                }, {
                    id: 'versions',
                    dataLabels: {
                        distance: 10,
                        format: '{point.custom.version}',
                        filter: {
                            property: 'percentage',
                            operator: '>',
                            value: 2
                        }
                    }
                }]
            }
        }]
    }
});
</script>

</div>
</body>
</html>
